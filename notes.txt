name: FreeTV EPG

on:
  schedule:
    - cron:  '0 23 * * *'          # every day 02:00 IL
  workflow_dispatch:

jobs:
  grab:
    runs-on: ubuntu-latest
    env:
      IL_PROXY: ${{ secrets.IL_PROXY }}   # http://user:pass@host:port
    steps:

    - uses: actions/checkout@v4

    # 1️⃣ Chrome (matching puppeteer 22.x) —  fast, no extra download
    - name: Setup Chrome
      id: chrome
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable

    # 2️⃣ Node deps (core puppeteer + stealth plugin + your grabber deps)
    - name: Install deps
      run: |
        npm ci
        npm install --no-save puppeteer-core puppeteer-extra puppeteer-extra-plugin-stealth

    # 3️⃣ Harvest fresh cookie (writes .env.ftv)
    - name: Harvest FreeTV cookie
      run: |
        node tools/harvest-ftv-cookie.mjs \
          "${{ steps.chrome.outputs.chrome-path }}" \
          "$IL_PROXY"
        cat .env.ftv >> $GITHUB_ENV

    # 4️⃣ Run your existing grab script (reads FREETV_COOKIE automatically)
    - name: Grab EPG JSON
      run: |
        NODE_OPTIONS="--max-old-space-size=4000" \
        npx tsx scripts/commands/epg/grab.ts \
          --channels=channels.xml \
          --maxConnections=1 \
          --timeout=20000 \
          --output=guide.xml \
          --proxy "$IL_PROXY"

    # 5️⃣ Commit the fresh XMLTV
    - uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ci(epg): daily FreeTV update"
        file_pattern: guide.xml
