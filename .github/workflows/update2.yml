name: Update2
on:
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      IL_PROXY: ${{ secrets.IL_PROXY }}

    steps:
    # 1 – source
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Allow expired Fortinet leaf  ⚠️ TEMPORARY
      run: |
         # 0️⃣  Trust *nothing* – disable TLS checks (Node & curl)
         echo "NODE_TLS_REJECT_UNAUTHORIZED=0" >> "$GITHUB_ENV"
  
         # 1️⃣  Make sure $HOME/bin exists
         mkdir -p "$HOME/bin"

         # 2️⃣  Drop a tiny wrapper that always adds --proxy and --proxy-insecure
         cat > "$HOME/bin/curl" <<'WRAP'
         #!/usr/bin/env bash
         exec /usr/bin/curl --proxy "$IL_PROXY" --proxy-insecure "$@"
         WRAP
         chmod +x "$HOME/bin/curl"

          # 3️⃣  Prepend $HOME/bin to PATH so our wrapper is found first
          echo "$HOME/bin" >> "$GITHUB_PATH"
    
    # 2 – python (kept for future use)
    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # 3 – download EPG grabbers
    - name: Downloading the EPG fetchers
      uses: actions/checkout@v4
      with:
        repository: iptv-org/epg
        path: epg

    # 4 – node
    - uses: actions/setup-node@v4
      with:
        node-version: 21.7.3

    # -------------------------------------------
    #  🥐 1. Install a Chrome that the runner can launch
    # -------------------------------------------
    - name: Set up Google Chrome
      id: chrome
      uses: browser-actions/setup-chrome@v1            # ≈ 10 s
      with:
        chrome-version: latest

    # -------------------------------------# -------------------------------------------
    #  🥐 2. Install a Puppeteer version that exists
    #     • Use the same major as Chrome *if* it’s on NPM
    #     • Otherwise fall back to the latest published tag
    # -------------------------------------------
    - name: Install puppeteer-core
      run: |
        set -e
        CHROME_MAJOR=$(echo "${{ steps.chrome.outputs.chrome-version }}" | cut -d'.' -f1)
        echo "Chrome major: $CHROME_MAJOR"
        if npm view "puppeteer-core@$CHROME_MAJOR" version >/dev/null 2>&1; then
          echo "→ Installing puppeteer-core@$CHROME_MAJOR"
          npm install --no-save --silent "puppeteer-core@$CHROME_MAJOR"
        else
          echo "→ puppeteer-core@$CHROME_MAJOR not yet published – falling back to latest"
          npm install --no-save --silent puppeteer-core@latest
        fi

    # -------------------------------------------
    #  Install stealth support on top of puppeteer-core
    # -------------------------------------------
    - name: Harvest FreeTV cookies
      env:
        CHROME_PATH: ${{ steps.chrome.outputs.chrome-path }}
        IL_PROXY   : ${{ env.IL_PROXY }}
      run: |
        node <<'EOF'
        const fs              = require('fs');
        const { addExtra }    = require('puppeteer-extra');
        const StealthPlugin   = require('puppeteer-extra-plugin-stealth');
        const puppeteerCore   = require('puppeteer-core');
        const puppeteer       = addExtra(puppeteerCore);   // ⬅ core + stealth
        puppeteer.use(StealthPlugin());

        const sleep = ms => new Promise(r => setTimeout(r, ms));

        (async () => {
          const browser = await puppeteer.launch({
            executablePath: process.env.CHROME_PATH,
            headless: 'new',
            args: [
              '--no-sandbox',
              '--disable-setuid-sandbox',
              '--ignore-certificate-errors',
              `--proxy-server=${process.env.IL_PROXY}`
            ]
          });

          const page = await browser.newPage();
          await page.setUserAgent(
            'Mozilla/5.0 (Windows NT 10.0; Win64; x64) ' +
            'AppleWebKit/537.36 (KHTML, like Gecko) '   +
            'Chrome/137.0.0.0 Safari/537.36'
          );
          await page.goto('https://web.freetv.tv/', { waitUntil: 'domcontentloaded' });

          // wait until Cloudflare sets cf_clearance (max 40 s)
          const client = await page.target().createCDPSession();
          let cookieStr = '';
          for (let i = 0; i < 20; i++) {
            const { cookies } = await client.send('Network.getAllCookies');
            cookieStr = cookies
              .filter(c => c.domain.endsWith('freetv.tv'))
              .map(c => `${c.name}=${c.value}`)
              .join('; ');
            if (cookieStr.includes('cf_clearance')) break;
            await sleep(2000);
          }
  
          if (!cookieStr.includes('cf_clearance')) {
            console.error('❌  Cloudflare challenge not solved after 40 s');
            process.exit(1);
          }
  
          console.log('::add-mask::' + cookieStr);
          fs.appendFileSync(process.env.GITHUB_ENV,
            `FREETV_COOKIE_HARVESTED=${cookieStr}\n`);
    
          await browser.close();
        })();
        EOF

    # -------------------------------------------
    #  🥐 4. Export the freshly harvested cookie so the grab step sees it
    # -------------------------------------------
    - name: Export harvested cookie
      run: |
        echo "FREETV_COOKIE_HARVESTED=${{ steps.harvest.outputs.FREETV_COOKIE_HARVESTED }}" >> "$GITHUB_ENV"
    
    # 5 – quick proxy test
    - name: Test proxy connectivity
      run: |
        # 1 — Ask curl to print the peer certificate
        curl -k -v --proxy "$IL_PROXY" \
        --connect-timeout 10 https://web.freetv.tv/ 2>&1 | \
        grep -A4 "Server certificate"

    - name: Test FreeTV API via proxy
      run: |
        curl --proxy "$IL_PROXY" -s -m 8 \
        -H 'Origin: https://web.freetv.tv' \
        -H 'Referer: https://web.freetv.tv/' \
        -A 'Mozilla/5.0' \
        -I 'https://web.freetv.tv/api/products/lives/programmes?liveId[]=3359448&since=2025-06-26T04:00+0300&till=2025-06-27T04:00+0300&lang=HEB&platform=BROWSER' \
        | head -n 1

    # 6 – install JS deps
    - name: Install JavaScript dependencies
      run: |
        cd epg
        npm ci

    # 7 – Fetch programmes
    - name: Fetching the programs data
      run: |
        cd epg

        # copy the patched site config (with headers function!)
        rm -f sites/freetv.tv/freetv.tv.config.js
        cp ../freetv.tv.config.js sites/freetv.tv/

        # copy patched grab.ts (with Buffer.from wrapper)
        rm -f scripts/commands/epg/grab.ts
        cp ../grab.ts scripts/commands/epg/

        # single socket; delay is inside the site file
        NODE_OPTIONS="--max-old-space-size=5000" \
        npx tsx scripts/commands/epg/grab.ts \
          --channels=../channels.xml \
          --maxConnections=1 \
          --timeout=20000 \
          --output=../guide.xml \
          --proxy "$IL_PROXY"
      env:
        IL_PROXY: ${{ secrets.IL_PROXY }}

    # 8 – cleanup
    - name: Remove the downloaded epg repo
      run: rm -rf epg
