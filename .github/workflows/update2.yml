name: Update2
on:
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      IL_PROXY: ${{ secrets.IL_PROXY }}

    steps:
    # 1 – source
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2 – python (kept for future use)
    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # 3 – download EPG grabbers
    - name: Downloading the EPG fetchers
      uses: actions/checkout@v4
      with:
        repository: iptv-org/epg
        path: epg

    # 4 – node
    - uses: actions/setup-node@v4
      with:
        node-version: 21.7.3

    - name: Pick a live Israeli proxy
      id: pickproxy
      shell: bash
      run: |
       set -e
       ua='Mozilla/5.0'
       echo "Pulling IL proxy lists…"
       list=$(
       {
        curl -sA "$ua" 'https://proxyscrape.com/free-proxy-list/israel?protocol=http';
        curl -sA "$ua" 'https://raw.githubusercontent.com/ShiftyTR/Proxy-List/master/https.txt';
        curl -sA "$ua" 'https://raw.githubusercontent.com/clarketm/proxy-list/master/proxy-list-raw.txt';
       } | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+' | sort -u | head -60
       )

       echo "Testing proxies…"
       for p in $list; do
        printf "  %-21s " "$p"
        if curl --proxy "http://$p" -A "$ua" -s -m 8 \
         -H 'Origin: https://web.freetv.tv' \
         -H 'Referer: https://web.freetv.tv/' \
         -I 'https://web.freetv.tv/api/products/lives/programmes?liveId[]=3359448&since=2025-06-26T04:00+0300&till=2025-06-27T04:00+0300&lang=HEB&platform=BROWSER' \
         | grep -q 'HTTP/1.1 200'; then
        echo "✅"
        echo "proxy=$p" >> "$GITHUB_OUTPUT"
        exit 0
       else
        echo "fail"
       fi
       done

       echo "::error ::No live IL proxy found"
       exit 1
       
    # 5 – quick proxy test
    - name: Test proxy connectivity
      run: |
        curl -s --max-time 8 --proxy "$IL_PROXY" -I https://web.freetv.tv/ | head

    - name: Test FreeTV API via proxy
      run: |
        curl --proxy "http://${{ steps.pickproxy.outputs.proxy }}" -s -m 8 \
        -H 'Origin: https://web.freetv.tv' \
        -H 'Referer: https://web.freetv.tv/' \
        -A 'Mozilla/5.0' \
        -I 'https://web.freetv.tv/api/products/lives/programmes?liveId[]=3359448&since=2025-06-26T04:00+0300&till=2025-06-27T04:00+0300&lang=HEB&platform=BROWSER' \
        | head -n 1

    # 6 – install JS deps
    - name: Install JavaScript dependencies
      run: |
        cd epg
        npm ci

    # 7 – Fetch programmes
    - name: Fetching the programs data
      run: |
        cd epg

        # copy the patched site config (with headers function!)
        rm -f sites/freetv.tv/freetv.tv.config.js
        cp ../freetv.tv.config.js sites/freetv.tv/

        # copy patched grab.ts (with Buffer.from wrapper)
        rm -f scripts/commands/epg/grab.ts
        cp ../grab.ts scripts/commands/epg/

        # single socket; delay is inside the site file
        NODE_OPTIONS="--max-old-space-size=5000" \
        npx tsx scripts/commands/epg/grab.ts \
          --channels=../channels.xml \
          --maxConnections=1 \
          --timeout=20000 \
          --output=../guide.xml \
          --proxy "http://${{ steps.pickproxy.outputs.proxy }}"
      env:
        IL_PROXY: ${{ secrets.IL_PROXY }}

    # 8 – cleanup
    - name: Remove the downloaded epg repo
      run: rm -rf epg
