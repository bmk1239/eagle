$url = "https://play.embyil.tv/emby/Users/AuthenticateByName"

$headers = @{
    "X-Emby-Authorization" = 'MediaBrowser Client="MyApp", Device="MyDevice", DeviceId="abc123", Version="1.0.0"'
    "Content-Type"         = "application/json"
}

$body = @{
    Username = "2200620"
    Pw       = "2200620"
} | ConvertTo-Json -Compress

$response = Invoke-RestMethod -Uri $url -Method Post -Headers $headers -Body $body

$response | Format-List

$accessToken = $response.AccessToken
$userId = $response.User.Id

# Step 2: Create permanent token
$tokenUrl = "https://play.embyil.tv/emby/Users/$userId/AccessTokens"

$tokenHeaders = @{
    "X-Emby-Token" = $accessToken
    "Content-Type" = "application/json"
}

$tokenBody = @{
    Name = "MyPermanentPowerShellToken"
} | ConvertTo-Json -Compress

$tokenResponse = Invoke-RestMethod -Uri $tokenUrl -Method Post -Headers $tokenHeaders -Body $tokenBody

Write-Host "`nâœ… Permanent token created!"
$tokenResponse | Format-List
